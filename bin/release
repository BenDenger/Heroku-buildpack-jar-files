#!/usr/bin/env bash
# bin/release <build-dir>

BP_DIR=$(cd $(dirname $0)/..; pwd)
. $BP_DIR/lib/common.sh

BUILD_DIR=$1

_ratpack_proc() {
  local ctxDir=$1
  if [ -d $ctxDir/build/install/*/bin ]; then
    (cd $ctxDir; find build/install/*/bin -type f -executable | grep -v "\.bat$")
  else
    echo -n ""
  fi
}

_ratpack_proc_count() {
  local ctxDir=$1
  _ratpack_proc $ctxDir | wc -l
}

_webapp_runner() {
  local ctxDir=$1
  (cd $ctxDir; find . -type f -name webapp-runner-*.jar)
}

echo "---"

if is_webapp_runner $BUILD_DIR; then
  echo "  web: web: cd build ; java \$JAVA_OPTS -jar $(_webapp_runner ${BUILD_DIR}/build) --expand-war --port \$PORT libs/*.war"
else
  echo "  web: java -Dserver.port=\$PORT \$JAVA_OPTS -jar build/libs/*.jar"
fi